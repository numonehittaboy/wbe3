import{P as B,d as F,B as N,c as O,aD as U}from"./index-j81mEYxC.js";function Z(s,r){let i,t,n,b=0,y=0,m=0,v=0,f=0;const x=4,d={},T=50,H=200,W=200;s.complete?_():s.onload=_;function R(){t.removeEventListener("mousedown",L),t.removeEventListener("touchstart",L),t.removeEventListener("wheel",P),document.removeEventListener("mouseup",h),document.removeEventListener("touchend",h),document.removeEventListener("mousemove",l),document.removeEventListener("touchmove",l),document.removeEventListener("keypress",D),i.remove(),t.remove(),n.remove()}function M(){t.addEventListener("mousedown",L,!1),t.addEventListener("touchstart",L,!1),t.addEventListener("wheel",P,!1),document.addEventListener("keypress",D,!1)}function _(){s.classList.add("crop-blur"),s.draggable=!1,n=new Image,n.src=s.src,n.draggable=!1,n.classList.add("crop-overlay-image"),r||(r=document.createElement("canvas")),i=document.createElement("div"),i.classList.add("crop-component"),t=document.createElement("div"),t.classList.add("crop-overlay");const e=document.createElement("div");e.classList.add("crop-overlay-color"),i.appendChild(t),s.parentNode.appendChild(i),i.appendChild(n),i.appendChild(s),i.appendChild(e),t.appendChild(n),n.style.maxWidth=s.width+"px",f=s.naturalWidth/s.offsetWidth;const c=s.offsetWidth/2-H/2,a=s.offsetHeight/2-W/2;k(H,W),C(c,a),E(c,a),M()}function k(e,o){m=e*f,v=o*f,t.style.width=e+"px",t.style.height=o+"px"}function C(e,o){y=o*f,b=e*f,n.style.top=-o+"px",n.style.left=-e+"px"}function E(e,o){t.style.top=o+"px",t.style.left=e+"px"}function S(e){d.container_width=t.offsetWidth,d.container_height=t.offsetHeight,d.container_left=t.offsetLeft,d.container_top=t.offsetTop,d.mouse_x=(e.clientX||e.pageX||e.touches&&e.touches[0].clientX)+window.scrollX,d.mouse_y=(e.clientY||e.pageY||e.touches&&e.touches[0].clientY)+window.scrollY}function w(e){e=e*Math.PI*2;const o=Math.floor(t.clientWidth+e),c=Math.floor(t.clientHeight+e),a=n.clientWidth,g=n.clientHeight;let p,u;if(o<T)return;if(o>a)return;p=t.offsetLeft-e/2,u=t.offsetTop-e/2;const A=p+o,X=u+c;p<0&&(p=0),u<0&&(u=0),!(A>a)&&(X>g||(k(o,o),C(p,u),E(p,u)))}function D(e){switch(e.preventDefault(),String.fromCharCode(e.charCode)){case"+":w(x);break;case"-":w(-x);break}}function P(e){e.preventDefault(),w(e.deltaY>0?1:-1)}function L(e){e.preventDefault(),e.stopPropagation(),S(e),document.addEventListener("mousemove",l),document.addEventListener("touchmove",l),document.addEventListener("mouseup",h),document.addEventListener("touchend",h)}function h(e){e.preventDefault(),document.removeEventListener("mouseup",h),document.removeEventListener("touchend",h),document.removeEventListener("mousemove",l),document.removeEventListener("touchmove",l)}function l(e){const o={x:0,y:0};e.preventDefault(),e.stopPropagation(),o.x=e.pageX||e.touches&&e.touches[0].pageX,o.y=e.pageY||e.touches&&e.touches[0].pageY;let c=o.x-(d.mouse_x-d.container_left),a=o.y-(d.mouse_y-d.container_top);const g=t.offsetWidth,p=t.offsetHeight;c<0?c=0:c>n.offsetWidth-g&&(c=n.offsetWidth-g),a<0?a=0:a>n.offsetHeight-p&&(a=n.offsetHeight-p),C(c,a),E(c,a)}function Y(){r.width=m,r.height=v,r.getContext("2d").drawImage(s,b,y,m,v,0,0,m,v)}return{crop:Y,removeHandlers:R}}function j(s,r){return new Promise(i=>{const t=new FileReader;t.addEventListener("loadend",n=>{i(n.target.result)}),t[r](s)})}function G(s){return j(s,"readAsDataURL")}class q extends B{constructor(r={}){super("popup-avatar",{closable:!0}),this.image=new Image,this.cropper={crop:()=>{},removeHandlers:()=>{}},this.h6=document.createElement("h6"),F(this.h6,"Popup.Avatar.Title"),this.btnClose.classList.remove("btn-icon"),this.header.append(this.h6),this.cropContainer=document.createElement("div"),this.cropContainer.classList.add("crop"),this.cropContainer.append(this.image),r.isForum&&this.cropContainer.classList.add("is-forum"),this.input=document.createElement("input"),this.input.type="file",this.input.style.display="none",this.listenerSetter.add(this.input)("change",i=>{const t=i.target.files[0];t&&G(t).then(n=>{this.image=new Image,this.cropContainer.append(this.image),this.image.src=n,this.image.onload=()=>{this.show(),this.cropper=Z(this.image,this.canvas),this.input.value=""}})},!1),this.btnConfirm=N("btn-primary btn-color-primary btn-circle btn-crop btn-icon z-depth-1",{noRipple:!0,icon:"check"}),O(this.btnConfirm,()=>{this.cropper.crop(),this.hide(),this.canvas.toBlob(i=>{this.blob=i,this.darkenCanvas(),this.resolve()},"image/jpeg",1)},{listenerSetter:this.listenerSetter}),this.container.append(this.cropContainer,this.btnConfirm,this.input),this.addEventListener("closeAfterTimeout",()=>{this.cropper.removeHandlers(),this.image&&this.image.remove()})}resolve(){this.onCrop(()=>U.upload(this.blob))}open(r,i){this.canvas=r,this.onCrop=i,this.input.click()}darkenCanvas(){const r=this.canvas.getContext("2d");r.fillStyle="rgba(0, 0, 0, 0.3)",r.fillRect(0,0,this.canvas.width,this.canvas.height)}}export{q as P,G as r};
//# sourceMappingURL=avatar-CSLfYsiI.js.map
